<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Чи-Фань — Выручка в реальном времени</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.6;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            margin: 0;
            color: var(--primary-color);
            font-weight: 700;
            font-size: 2.5rem;
        }

        .theme-toggle {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .theme-toggle:hover {
            background: #2563eb;
        }

        #last-update {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .export-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
            font-size: 0.9rem;
        }

        .export-btn:hover {
            background: #059669;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: slideIn 0.5s ease;
            opacity: 0;
            transform: translateY(20px);
        }

        .metric-card.fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .metric-icon {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .progress-container {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 10px;
            font-size: 1rem;
            font-weight: 500;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 1s ease;
            border-radius: 10px;
        }

        .progress-fill.good { background: linear-gradient(90deg, var(--success-color), #059669); }
        .progress-fill.warn { background: linear-gradient(90deg, var(--warning-color), #d97706); }
        .progress-fill.bad { background: linear-gradient(90deg, var(--danger-color), #dc2626); }

        .progress-text {
            text-align: center;
            font-weight: 500;
            margin-top: 10px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .venues-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .venue-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: box-shadow 0.3s ease;
            cursor: pointer;
        }

        .venue-card:hover {
            box-shadow: var(--shadow-hover);
        }

        .venue-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .venue-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .venue-metric-value {
            font-weight: 500;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .chart-container canvas {
            color: var(--text-primary);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .venues-grid { grid-template-columns: 1fr; }
            body { padding: 10px; }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
        }

        .error-msg {
            color: var(--danger-color);
            text-align: center;
            padding: 10px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 8px;
            margin: 10px 0;
        }

        .data-selector {
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .date-range-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .date-range-selector input, .date-range-selector button {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
            color: var(--text-primary);
        }
        
        .date-range-selector button {
            background: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .date-range-selector button:hover {
            background: #2563eb;
        }
        
        .metric-value.good, .metric-value.warn, .metric-value.bad {
            color: inherit;
        }
    </style>
</head>
<body data-theme="light">
    <div class="container">
        <header>
            <h1><i class="fas fa-utensils"></i> Чи-Фань — Выручка в реальном времени</h1>
            <button class="theme-toggle" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
        </header>
        <div id="last-update"><i class="fas fa-clock"></i> Загрузка...</div>
        
        <div class="date-range-selector">
            <label for="start-date">Начальная дата:</label>
            <input type="date" id="start-date">
            <label for="end-date">Конечная дата:</label>
            <input type="date" id="end-date">
            <button onclick="loadCustomData()"><i class="fas fa-download"></i> Загрузить</button>
        </div>
        <div class="metrics-grid" id="metrics"></div>

        <div class="progress-container">
            <h3><i class="fas fa-chart-line"></i> Прогресс по плану</h3>
            <div class="progress-header">
                <span>Текущее: <span id="current-value">0 ₽</span></span>
                <span>План: <span id="plan-value">0 ₽</span></span>
            </div>
            <div class="progress-bar">
                <div id="plan-bar" class="progress-fill"></div>
            </div>
            <div id="progress-text" class="progress-text">0%</div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <h4>Выручка по филиалам</h4>
                <canvas id="barChart1"></canvas>
            </div>
            <div class="chart-container">
                <h4>Статистика по типам</h4>
                <select class="data-selector" id="dataType" onchange="updateBarChart2()">
                    <option value="revenue">Выручка</option>
                    <option value="orders">Заказы</option>
                    <option value="delivery">Доставка</option>
                    <option value="cafe">Кафе</option>
                    <option value="pickup">Самовывоз</option>
                </select>
                <canvas id="barChart2"></canvas>
            </div>
        </div>

        <div class="section">
            <h3 class="section-title"><i class="fas fa-building"></i> Круглогодичные филиалы</h3>
            <div class="venues-grid" id="year-round"></div>
        </div>

        <div class="section">
            <h3 class="section-title"><i class="fas fa-leaf"></i> Сезонные филиалы</h3>
            <div class="venues-grid" id="seasonal"></div>
        </div>

        <div class="export-buttons">
            <button class="export-btn" onclick="exportPDF('all')"><i class="fas fa-file-pdf"></i> Экспорт PDF (Все)</button>
            <button class="export-btn" onclick="exportPDF('year-round')"><i class="fas fa-file-pdf"></i> PDF Круглогодичные</button>
            <button class="export-btn" onclick="exportPDF('seasonal')"><i class="fas fa-file-pdf"></i> PDF Сезонные</button>
        </div>

        <div id="toast" class="toast"></div>
    </div>

    <script>
        let barChart1, barChart2;
        let dataCache = {}; // Кэш для хранения загруженных данных по датам
        let currentStartDate = '';
        let currentEndDate = '';

        // --- КОНСТАНТЫ И НАСТРОЙКИ ---
        const DAILY_NETWORK_PLAN = 50000; // Ежедневный план сети по умолчанию
        const BASE_DATA_URL = 'https://wwwgolybfs-dev.github.io/chifan2025/data/daily/';
        const fmt = new Intl.NumberFormat('ru-RU');

        // Индивидуальные дневные планы для расчета выполнения плана по филиалам
        const fixedDailyPlans = {
            "Тобольская": 70000,
            "Тихая": 55000,
            "Красота": 80000,
        };

        // --- УТИЛИТЫ ---

        function getTodayDateString() {
            const today = new Date();
            today.setFullYear(2025, 9, 6); // Сегодня 06.10.2025
            return today.toISOString().split('T')[0];
        }

        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            const icon = document.querySelector('.theme-toggle i');
            icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            updateChartTheme();
        }
        
        function updateChartTheme() {
            const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
            const updateOptions = { 
                scales: { 
                    x: { title: { color: textColor }, ticks: { color: textColor } }, 
                    y: { title: { color: textColor }, ticks: { color: textColor } } 
                }, 
                plugins: { legend: { labels: { color: textColor } } } 
            };
            
            if (barChart1) {
                Object.assign(barChart1.options.scales, updateOptions.scales);
                barChart1.options.plugins.legend.labels.color = textColor;
                barChart1.update();
            }
            if (barChart2) {
                Object.assign(barChart2.options.scales, updateOptions.scales);
                barChart2.options.plugins.legend.labels.color = textColor;
                barChart2.update();
            }
        }

        function getStatusClass(fulfill) {
            if (fulfill >= 100) return 'good';
            if (fulfill >= 80) return 'warn';
            return 'bad';
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.textContent = message;
            toast.style.background = type === 'error' ? 'var(--danger-color)' : 'var(--success-color)';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function getDiffDays(startDateStr, endDateStr) {
            const start = new Date(startDateStr);
            const end = new Date(endDateStr);
            if (isNaN(start) || isNaN(end)) return 1;
            const diffTime = Math.abs(end - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        }

        // --- ЛОГИКА ЗАГРУЗКИ ДАННЫХ ---
        
        async function fetchDataForDate(dateStr) {
            if (dataCache[dateStr]) return dataCache[dateStr];
            
            const url = `${BASE_DATA_URL}${dateStr}_revenue.json`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    if (response.status === 404) {
                        console.warn(`Файл для ${dateStr} не найден, возвращаем пустые данные с планом`);
                        return {
                            date: dateStr, time: "00:00", year_round: {}, seasonal: {}, 
                            plan: { total_revenue: DAILY_NETWORK_PLAN, total_orders: 1000 },
                            total: { total_revenue: 0, total_orders: 0 }
                        };
                    }
                    throw new Error(`Ошибка загрузки данных: ${response.statusText}`);
                }
                
                const data = await response.json();
                let calculatedRevenue = 0;
                let calculatedOrders = 0;
                const allVenues = { ...data.year_round, ...data.seasonal };
                
                Object.values(allVenues).forEach(stats => {
                    calculatedRevenue += stats.total_revenue || 0;
                    calculatedOrders += stats.total_orders || 0;
                });
                
                const planRevenue = data.plan?.total_revenue || DAILY_NETWORK_PLAN;
                const planOrders = data.plan?.total_orders || 1000;

                const result = {
                    ...data,
                    plan: { total_revenue: planRevenue, total_orders: planOrders },
                    total: {
                        total_revenue: calculatedRevenue,
                        total_orders: calculatedOrders
                    }
                };
                
                dataCache[dateStr] = result;
                return result;

            } catch (error) {
                console.warn(`Не удалось загрузить данные для ${dateStr}: ${error.message}`);
                return {
                    date: dateStr, time: "00:00", year_round: {}, seasonal: {}, 
                    plan: { total_revenue: DAILY_NETWORK_PLAN, total_orders: 1000 },
                    total: { total_revenue: 0, total_orders: 0 }
                };
            }
        }

        async function loadData(startDateStr, endDateStr) {
            const diffDays = getDiffDays(startDateStr, endDateStr);
            let combinedData = {
                year_round: {}, seasonal: {}, 
                total: { total_revenue: 0, total_orders: 0 },
                date: `${startDateStr} - ${endDateStr}`,
                time: "23:59"
            };

            const dateList = [];
            let currentDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            
            if (isNaN(currentDate) || isNaN(endDate) || currentDate > endDate) {
                combinedData.plan = { total_revenue: DAILY_NETWORK_PLAN * diffDays, total_orders: 1000 * diffDays };
                return combinedData;
            }

            while (currentDate <= endDate) {
                dateList.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            let totalDailyPlan = 0;
            const promises = dateList.map(dateStr => fetchDataForDate(dateStr));
            const dailyResults = await Promise.all(promises);

            dailyResults.forEach(dailyData => {
                combinedData.total.total_revenue += dailyData.total.total_revenue || 0;
                combinedData.total.total_orders += dailyData.total.total_orders || 0;

                const venuesToCombine = { ...dailyData.year_round, ...dailyData.seasonal };
                for (const venue in venuesToCombine) {
                    const stats = venuesToCombine[venue];
                    let existingStats = combinedData.year_round[venue] || combinedData.seasonal[venue];
                    
                    if (!existingStats) {
                        const target = dailyData.year_round[venue] ? combinedData.year_round : combinedData.seasonal;
                        target[venue] = { ...stats };
                    } else {
                        for (const key in stats) {
                            if (typeof stats[key] === 'number') {
                                existingStats[key] = (existingStats[key] || 0) + (stats[key] || 0);
                            }
                        }
                    }
                }
                
                totalDailyPlan += dailyData.plan.total_revenue || DAILY_NETWORK_PLAN;
            });

            combinedData.plan = {
                total_revenue: totalDailyPlan,
                total_orders: 1000 * diffDays
            };
            
            if (diffDays === 1 && dailyResults[0].time !== "00:00") {
                combinedData.time = dailyResults[0].time;
            }
            
            return combinedData;
        }

        // --- РЕНДЕРИНГ ---

        function renderMetrics(data) {
            const total = data.total || { total_revenue: 0, total_orders: 0 };
            const plan = data.plan || { total_revenue: DAILY_NETWORK_PLAN, total_orders: 1000 };
            
            const avg_bill = total.total_orders > 0 ? total.total_revenue / total.total_orders : 0;
            const revenueFulfill = plan.total_revenue > 0 ? (total.total_revenue / plan.total_revenue) * 100 : 0;
            
            document.getElementById('metrics').innerHTML = `
                <div class="metric-card fade-in">
                    <div class="metric-icon"><i class="fas fa-ruble-sign"></i></div>
                    <div class="metric-value">${fmt.format(total.total_revenue.toFixed(0))} ₽</div>
                    <div class="metric-label">Выручка за период</div>
                </div>
                <div class="metric-card fade-in">
                    <div class="metric-icon"><i class="fas fa-shopping-cart"></i></div>
                    <div class="metric-value">${total.total_orders}</div>
                    <div class="metric-label">Заказы за период</div>
                </div>
                <div class="metric-card fade-in">
                    <div class="metric-icon"><i class="fas fa-receipt"></i></div>
                    <div class="metric-value">${fmt.format(avg_bill.toFixed(0))} ₽</div>
                    <div class="metric-label">Средний чек</div>
                </div>
                <div class="metric-card fade-in">
                    <div class="metric-icon"><i class="fas fa-percent"></i></div>
                    <div class="metric-value ${getStatusClass(revenueFulfill)}">${revenueFulfill.toFixed(1)}%</div>
                    <div class="metric-label">Выполнение плана (Выручка)</div>
                </div>
            `;

            const bar = document.getElementById('plan-bar');
            const progressText = document.getElementById('progress-text');
            const currentValue = document.getElementById('current-value');
            const planValue = document.getElementById('plan-value');

            if (bar && progressText && currentValue && planValue) {
                bar.className = `progress-fill ${getStatusClass(revenueFulfill)}`;
                bar.style.width = Math.min(revenueFulfill, 100) + '%';
                progressText.textContent = `${revenueFulfill.toFixed(1)}%`;
                currentValue.textContent = `${fmt.format(total.total_revenue.toFixed(0))} ₽`;
                planValue.textContent = `${fmt.format(plan.total_revenue.toFixed(0))} ₽`;
            }

            if (revenueFulfill > 100) {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            }
        }

        function renderVenueCard(venue, stats) {
            const dailyPlan = fixedDailyPlans[venue] || DAILY_NETWORK_PLAN;
            const diffDays = getDiffDays(currentStartDate, currentEndDate);
            const planRevenueForPeriod = dailyPlan * diffDays;
            
            const fulfill = planRevenueForPeriod > 0 ? (stats.total_revenue || 0) / planRevenueForPeriod * 100 : 0;
            const statusClass = getStatusClass(fulfill);
            
            return `
                <div class="venue-card fade-in">
                    <div class="venue-name">${venue}</div>
                    <div class="venue-metric"><span>Выручка:</span> <span class="venue-metric-value ${statusClass}">${fmt.format((stats.total_revenue || 0).toFixed(0))} ₽</span></div>
                    <div class="venue-metric"><span>Заказы:</span> <span>${stats.total_orders || 0}</span></div>
                    <div class="venue-metric"><span>Доставка:</span> <span>${fmt.format((stats.delivery_revenue || 0).toFixed(0))} ₽</span></div>
                    <div class="venue-metric"><span>Кафе:</span> <span>${fmt.format((stats.cafe_revenue || 0).toFixed(0))} ₽</span></div>
                    <div class="venue-metric"><span>Самовывоз:</span> <span>${fmt.format((stats.pickup_revenue || 0).toFixed(0))} ₽</span></div>
                    <div style="margin-top: 10px;">
                        <div class="progress-bar" style="height: 8px;">
                            <div class="progress-fill ${statusClass}" style="width: ${Math.min(fulfill, 100)}%;"></div>
                        </div>
                        <small>${fulfill.toFixed(1)}% от плана (${fmt.format(planRevenueForPeriod.toFixed(0))} ₽)</small>
                    </div>
                </div>
            `;
        }

        function renderVenues(data, containerId) {
            const key = containerId === 'year-round' ? 'year_round' : 'seasonal';
            const venues = data[key] || {};
            const container = document.getElementById(containerId);
            
            if (!container) return;

            if (Object.keys(venues).length === 0) {
                container.innerHTML = '<div class="error-msg">Нет данных по филиалам</div>';
                return;
            }
            
            const sortedVenues = Object.entries(venues).sort((a, b) => (b[1].total_revenue || 0) - (a[1].total_revenue || 0));
            container.innerHTML = sortedVenues.map(([venue, stats]) => renderVenueCard(venue, stats)).join('');
        }

        // --- ФУНКЦИИ ГРАФИКОВ ---
        
        function renderCharts(data) {
            const allVenues = { ...data.year_round, ...data.seasonal };
            const labels = Object.keys(allVenues).length > 0 ? Object.keys(allVenues) : ['Нет данных'];
            const revenues = labels.map(l => allVenues[l]?.total_revenue || 0);

            const ctxBar1 = document.getElementById('barChart1')?.getContext('2d');
            const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
            
            if (ctxBar1) {
                if (barChart1) barChart1.destroy();
                barChart1 = new Chart(ctxBar1, {
                    type: 'bar',
                    data: { 
                        labels, 
                        datasets: [{ 
                            label: 'Выручка ₽', 
                            data: revenues, 
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316'] 
                        }] 
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { title: { display: true, text: 'Филиалы', color: textColor }, ticks: { color: textColor } },
                            y: { beginAtZero: true, title: { display: true, text: 'Выручка ₽', color: textColor }, ticks: { color: textColor } }
                        },
                        plugins: { legend: { position: 'bottom', labels: { color: textColor } } }
                    }
                });
            }

            updateBarChart2(data);
        }

        function updateBarChart2(data) {
            const dataType = document.getElementById('dataType').value;
            const allVenues = data ? { ...data.year_round, ...data.seasonal } : {};
            const labels = Object.keys(allVenues).length > 0 ? Object.keys(allVenues) : ['Нет данных'];
            const ctxBar2 = document.getElementById('barChart2')?.getContext('2d');
            const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
            let dataValues;

            switch(dataType) {
                case 'orders':
                    dataValues = labels.map(l => allVenues[l]?.total_orders || 0);
                    break;
                case 'delivery':
                    dataValues = labels.map(l => allVenues[l]?.delivery_revenue || 0);
                    break;
                case 'cafe':
                    dataValues = labels.map(l => allVenues[l]?.cafe_revenue || 0);
                    break;
                case 'pickup':
                    dataValues = labels.map(l => allVenues[l]?.pickup_revenue || 0);
                    break;
                default: // revenue
                    dataValues = labels.map(l => allVenues[l]?.total_revenue || 0);
            }

            if (ctxBar2) {
                if (barChart2) barChart2.destroy();
                barChart2 = new Chart(ctxBar2, {
                    type: 'bar',
                    data: { 
                        labels, 
                        datasets: [{ 
                            label: `${dataType === 'orders' ? 'Заказы' : 'Выручка ₽'}`, 
                            data: dataValues, 
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316'] 
                        }] 
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: { title: { display: true, text: 'Филиалы', color: textColor }, ticks: { color: textColor } },
                            y: { beginAtZero: true, title: { display: true, text: dataType === 'orders' ? 'Количество заказов' : 'Выручка ₽', color: textColor }, ticks: { color: textColor } }
                        },
                        plugins: { legend: { position: 'bottom', labels: { color: textColor } } }
                    }
                });
            }
        }
        
        // --- УПРАВЛЕНИЕ ЗАГРУЗКОЙ ---

        function loadCustomData() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!startDate || !endDate) {
                showToast('Пожалуйста, выберите начальную и конечную дату', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showToast('Начальная дата не может быть позже конечной', 'error');
                return;
            }
            
            const periodText = (startDate === endDate) ? 
                `за день ${new Date(startDate).toLocaleDateString('ru-RU')}` : 
                `за период с ${new Date(startDate).toLocaleDateString('ru-RU')} по ${new Date(endDate).toLocaleDateString('ru-RU')}`;
                
            showToast(`Загрузка данных ${periodText}`);
            load(startDate, endDate);
        }

        async function load(startDateStr, endDateStr) {
            const updateEl = document.getElementById('last-update');
            if (updateEl) updateEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Загрузка...';
            
            currentStartDate = startDateStr;
            currentEndDate = endDateStr;

            try {
                const data = await loadData(startDateStr, endDateStr); 
                dataCache.current = data;

                let dateDisplay;
                if (startDateStr && endDateStr) {
                    dateDisplay = (startDateStr === endDateStr) ? 
                        new Date(startDateStr).toLocaleDateString('ru-RU') : 
                        `${new Date(startDateStr).toLocaleDateString('ru-RU')} - ${new Date(endDateStr).toLocaleDateString('ru-RU')}`;
                } else {
                    dateDisplay = 'Нет данных';
                }
                    
                if (updateEl) updateEl.innerHTML = `<i class="fas fa-check-circle"></i> Обновлено: ${data.time} (${dateDisplay})`;

                renderMetrics(data);
                renderVenues(data, 'year-round');
                renderVenues(data, 'seasonal');
                renderCharts(data); 
                
                updateChartTheme();

            } catch (e) {
                console.error('Ошибка загрузки:', e);
                if (updateEl) updateEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Ошибка загрузки';
                document.getElementById('metrics').innerHTML = '<div class="error-msg">Ошибка загрузки метрик</div>';
                document.getElementById('year-round').innerHTML = '<div class="error-msg">Ошибка загрузки филиалов</div>';
                document.getElementById('seasonal').innerHTML = '<div class="error-msg">Ошибка загрузки филиалов</div>';
                showToast('Критическая ошибка загрузки данных', 'error');
            } finally {
                document.querySelectorAll('.metric-card, .venue-card').forEach((el, index) => {
                    setTimeout(() => el.classList.add('fade-in'), index * 50);
                });
            }
        }
        
        // --- PDF Export (использует кэшированные агрегированные данные) ---

        function exportPDF(filter = 'all') {
            const data = dataCache.current;
            if (!data || !data.date) {
                showToast('Нет данных для экспорта', 'error');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
            
            function escapeText(text) {
                return text.replace(/[а-яА-ЯёЁ]/g, (char) => {
                    const translitMap = { 'а': 'a', 'б': 'b', 'в': 'v', 'г': 'g', 'д': 'd', 'е': 'e', 'ё': 'yo', 'ж': 'zh', 'з': 'z', 'и': 'i', 'й': 'y', 'к': 'k', 'л': 'l', 'м': 'm', 'н': 'n', 'о': 'o', 'п': 'p', 'р': 'r', 'с': 's', 'т': 't', 'у': 'u', 'ф': 'f', 'х': 'kh', 'ц': 'ts', 'ч': 'ch', 'ш': 'sh', 'щ': 'sch', 'ъ': '"', 'ы': 'y', 'ь': "'", 'э': 'e', 'ю': 'yu', 'я': 'ya', 'А': 'A', 'Б': 'B', 'В': 'V', 'Г': 'G', 'Д': 'D', 'Е': 'E', 'Ё': 'Yo', 'Ж': 'Zh', 'З': 'Z', 'И': 'I', 'Й': 'Y', 'К': 'K', 'Л': 'L', 'М': 'M', 'Н': 'N', 'О': 'O', 'П': 'P', 'Р': 'R', 'С': 'S', 'Т': 'T', 'У': 'U', 'Ф': 'F', 'Х': 'Kh', 'Ц': 'Ts', 'Ч': 'Ch', 'Ш': 'Sh', 'Щ': 'Sch', 'Ъ': '"', 'Ы': 'Y', 'Ь': "'", 'Э': 'E', 'Ю': 'Yu', 'Я': 'Ya' };
                    return translitMap[char] || char;
                });
            }
            
            doc.setFont("helvetica");
            doc.setFontSize(14);
            doc.text(escapeText('Чи-Фань Отчет по Выручке'), 10, 10);
            doc.setFontSize(10);
            const dateText = `Дата отчета: ${data.date} ${data.time || ''}`;
            doc.text(dateText, 10, 15);

            let y = 25;
            const venues = filter === 'year-round' ? data.year_round : filter === 'seasonal' ? data.seasonal : { ...data.year_round, ...data.seasonal };
            
            const sortedVenues = Object.entries(venues || {}).sort((a, b) => (b[1].total_revenue || 0) - (a[1].total_revenue || 0));

            sortedVenues.forEach(([v, s]) => {
                const text = `${v}: Выручка ${fmt.format((s.total_revenue || 0).toFixed(0))} ₽, Заказы ${s.total_orders || 0}`;
                doc.text(escapeText(text), 10, y);
                y += 7;
                if (y > 280) {
                    doc.addPage();
                    y = 15;
                }
            });

            doc.save(`chifan_report_${currentStartDate.replace(/-/g, '_')}_${filter}.pdf`);
            showToast('PDF экспортирован!');
        }

        // --- Инициализация ---

        if (localStorage.getItem('theme') === 'dark') toggleTheme();
        
        const todayStr = getTodayDateString();
        document.getElementById('start-date').value = todayStr;
        document.getElementById('end-date').value = todayStr;
        
        load(todayStr, todayStr); 
        
        setInterval(() => {
            if (currentStartDate === currentEndDate && currentStartDate === getTodayDateString()) {
                load(currentStartDate, currentEndDate);
            }
        }, 4 * 60 * 1000);
    </script>
</body
